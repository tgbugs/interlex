#!/usr/bin/env bash
# interlex-dbsetup [PORT] [DATABASE]
set -e
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve all symlinks
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # resolve relative symlinks
done
ABS_PATH="$( cd -P "$( dirname "$SOURCE" )" && pwd )"

SQL="${ABS_PATH}/../sql/"
RESOURCES="${ABS_PATH}/../resources/"

if [ ! -d "${SQL}" ]; then
  # installed outside of git
  SQL="${ABS_PATH}/../share/interlex/sql/"
  RESOURCES="${ABS_PATH}/../share/interlex/resources/"
fi

if [ -z $1 ]; then
    PORT=5432
else
    PORT=$1
fi

if [ -z $2 ]; then
    DATABASE=$(python -c 'from interlex.config import auth; print(auth.get("test-database"))')
else
    DATABASE=$2
fi

echo running dbsetup for ${DATABASE}

# postgres setup (these need to fail loudly)
psql -U postgres -h localhost -p ${PORT} -d postgres  -f "${SQL}/postgres.sql" -v ON_ERROR_STOP=on -v database=$DATABASE
psql -U postgres -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/extensions.sql" -v ON_ERROR_STOP=on

# interlex-admin setup
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/schemas.sql" -v ON_ERROR_STOP=on
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/groups.sql" -v ON_ERROR_STOP=on
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/triples.sql" -v ON_ERROR_STOP=on
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/user-uris.sql" -v ON_ERROR_STOP=on
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/inserts.sql" -v ON_ERROR_STOP=on -v resources=${RESOURCES}
psql -U interlex-admin -h localhost -p ${PORT} -d ${DATABASE} -f "${SQL}/permissions.sql" -v ON_ERROR_STOP=on -v database=${DATABASE}

# tests
export DBSETUPTEST=1
# FIXME only run tests if we are on testing database probably to avoid pollution?
export INTERLEX_TEST_DATABASE=${DATABASE}
echo running python tests 
cd ${ABS_PATH}/../
pytest test/test_constraints.py
unset DBSETUPTEST
unset INTERLEX_TEST_DATABASE
